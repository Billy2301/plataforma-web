@model IniciarSesionViewModel
@using Microsoft.AspNetCore.Identity;
@using PortalClienteV2.Models.ViewModel;
@inject SignInManager<IdentityUser> signInManager
@{
    ViewData["title"] = "Iniciar sesión de usuario";
    Layout = "~/Views/Shared/_LayoutAcceso.cshtml";
}

<div class="authentication-login min-vh-100 bg-body row justify-content-center align-items-center p-4">
    <div class="auth-max-width col-sm-8 col-md-6 col-xl-7 px-4">
        <h2 class="mb-1 fs-7 fw-bolder text-primary"><small>Bienvenido al</small><br /> Portal del usuario</h2>
@*         <h7 class="mb-1 fw-bolder text-primary">Del Instituto de Diagnóstico y Tratamiento CPAL</h7>
 *@        <div class="subtitle-warning mb-2"></div>
@*         <p class="mb-7">En este espacio podrá solicitar citas, gestionar pagos, consultar el historial y realizar otras gestiones</p>
 *@        
        <!-- inicio de formularios-->
        <div class="login-wrap mt-5">
@*             @{
                if (ViewBag.Error != null)
                {
                    <div class="alert customize-alert alert-dismissible alert-light-danger bg-danger-subtle text-danger fade show remove-close-icon" role="alert">
                        <a class="btn-close" data-bs-dismiss="alert" aria-label="Close"></a>
                        <div class="d-flex align-items-center  me-3 me-md-0">
                            <i class="ti ti-info-circle fs-5 me-2 text-danger"></i>
                            @{
                                ViewBag.Error = ViewBag.Error.Replace("Passwords must have at least one lowercase", "Las contraseñas deben tener al menos una minúscula")
                                .Replace("Passwords must have at least one uppercase", "Las contraseñas deben tener al menos una mayúscula")
                                .Replace("Passwords must have at least one non alphanumeric character", "Las contraseñas deben tener al menos un carácter no alfanumérico")
                                .Replace("Passwords must have at least one digit", "Las contraseñas deben tener al menos un dígito");
                            }
                            @Html.Raw(ViewBag.Error) !
                        </div>
                    </div>
                }

            } *@
            <div class="login-html">
                <input id="tab-1" type="radio" name="tab" class="sign-in"><label for="tab-1" class="tab tab-checked">Iniciar sesión</label>
                <input id="tab-2" type="radio" name="tab" class="sign-up"><label for="tab-2" class="tab" onclick="Redirigir()">Registrarse</label>
               

                <div class="login-form mt-3">
                    <!-- login-form -->
                    <div class="sign-in-htm p-3">

                        @{
                            var esquemas = await signInManager.GetExternalAuthenticationSchemesAsync();
                            var proveedoresAcceso = esquemas.ToList();
                        }


                        <form asp-controller="Acceso" asp-action="IniciarSesion" method="post" onsubmit="return subminLoagin(this)">
                            @{
                                if (ViewBag.Error != null)
                                {
                                    <div class="alert customize-alert alert-dismissible alert-light-danger bg-danger-subtle text-danger fade show remove-close-icon" role="alert">
                                        <a class="btn-close" data-bs-dismiss="alert" aria-label="Close"></a>
                                        <div class="d-flex align-items-center  me-3 me-md-0">
                                            <i class="ti ti-info-circle fs-5 me-2 text-danger"></i>
                                            @{
                                                ViewBag.Error = ViewBag.Error.Replace("Passwords must have at least one lowercase", "Las contraseñas deben tener al menos una minúscula")
                                                .Replace("Passwords must have at least one uppercase", "Las contraseñas deben tener al menos una mayúscula")
                                                .Replace("Passwords must have at least one non alphanumeric character", "Las contraseñas deben tener al menos un símbolo")
                                                .Replace("Passwords must have at least one digit", "Las contraseñas deben tener al menos un dígito");
                                            }
                                            @Html.Raw(ViewBag.Error)
                                        </div>
                                    </div>
                                }

                            }
                            <div class="form-floating mb-3">
                                <input asp-for="Email" type="email" class="form-control" id="exampleInputEmail1" aria-describedby="emailHelp" placeholder="Correo" data-val-email="El campo Correo electrónico no es una dirección de correo electrónico válida." autocomplete="off">
                                <label asp-for="Email"><i class="ti ti-mail me-2 fs-4"></i>Correo</label>
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                            <div class="form-floating mb-4">
                                <i onclick="toggleShowPassword('Password')" id="iPassword" class="show-password ti ti-eye-off"></i>
                                <input asp-for="Password" type="password" id="txtPassword" class="form-control" placeholder="Clave" autocomplete="off">
                                <label asp-for="Password"><i class="ti ti-lock me-2 fs-4"></i>Contraseña</label>
                                <span asp-validation-for="Password" class="text-danger"></span>
                            </div>
                            <div class="d-md-flex align-items-center justify-content-between mb-4">
                                <div class="form-check mb-4 mb-md-0">
                                    <input asp-for="RememberMe" class="form-check-input primary" type="checkbox" value="true" id="RememberMe" checked>
                                    <label class="form-check-label text-dark fs-3" asp-for="RememberMe">
                                        @Html.DisplayNameFor(m => m.RememberMe)
                                    </label>
                                </div>
                                <a class="text-primary fw-medium fs-3" asp-controller="Acceso" asp-action="RecuperarContraseña">¿Olvidó su contraseña?</a>
                            </div>
                            <button type="submit" class="btn btn-primary w-100 py-8 mb-4 rounded-2">Iniciar sesión</button>

                            @* <div class="d-md-flex align-items-center justify-content-center">
                                <p class="fs-4 mb-0 fw-medium me-2">Si no tiene una cuenta puede</p>
                                <a class="text-primary fw-medium " asp-area="" asp-controller="Acceso" asp-action="Registro">crearla aquí</a>
                            </div> *@
                        </form>
                        @if (proveedoresAcceso.Count > 0)
                        {
                            <div class="position-relative text-center my-3">
                                <p class="mb-0 fs-4 px-3 d-inline-block bg-body text-dark z-index-5 position-relative">
                                    O inicie sesión con
                                </p>
                                <span class="border-top w-100 position-absolute top-50 start-50 translate-middle"></span>
                            </div>
                            <div>
                                <form asp-controller="Acceso" asp-action="AccesoExterno" asp-route-returnurl="@ViewData["ReturnUrl"]" method="post" class="row d-flex">
                                    @foreach (var proveedor in proveedoresAcceso)
                                    {
                                        if (@proveedor.Name == "Facebook")
                                        {
                                            <div class="col-md-6 mb-2 m-auto d-none">
                                                <button class="justify-content-center w-100 btn mb-1 btn-light text-dark  d-flex text-dark align-items-center border" name="proveedor" value="@proveedor.Name" title="Acceda usando su cuenta @proveedor.Name">
                                                    <img src="../assets/images/svgs/facebook-icon.svg" alt="" class="img-fluid me-2" width="18"
                                                         height="18">
                                                    <span class="flex-shrink-0">@proveedor.Name</span>
                                                </button>
                                            </div>
                                        }
                                        if (@proveedor.Name == "Google")
                                        {
                                            <div class="col-md-6 mb-2 m-auto">
                                                <button class="justify-content-center w-100 btn mb-1 btn-light text-dark  d-flex text-dark align-items-center border" name="proveedor" value="@proveedor.Name" title="Acceda usando su cuenta @proveedor.Name">
                                                    <img src="../assets/images/svgs/google-icon.svg" alt="" class="img-fluid me-2" width="18"
                                                         height="18">
                                                    <span class="flex-shrink-0">@proveedor.Name </span>
                                                </button>
                                            </div>
                                        }
                                        if (@proveedor.Name == "Microsoft")
                                        {
                                            <div class="col-md-6 mb-2 m-auto">
                                                <button class="justify-content-center w-100 btn mb-1 btn-light text-dark  d-flex text-dark align-items-center border" name="proveedor" value="@proveedor.Name" title="Acceda usando su cuenta @proveedor.Name">
                                                    <img src="../assets/images/svgs/microsoft-icon.svg" alt="" class="img-fluid me-2" width="18"
                                                         height="18">
                                                    <span class="flex-shrink-0">@proveedor.Name </span>
                                                </button>
                                            </div>
                                        }
                                    }
                                </form>
                            </div>


                        }

                    </div>

                    <!-- loading icon -->
                    <div class="tab-loading my-5 w-100 text-center d-none">
                        <div class="spinner-border mt-5 text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>



    </div>
</div>
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        function toggleShowPassword(id) {
            var passwordField = document.getElementById("txt" + id);
            var eye = document.getElementById("i" + id);
            console.log(eye)
            //Mostrar u ocultar el password
            if (passwordField.type === "password") {
                passwordField.type = "text";
                eye.classList.remove("ti-eye-off");
                eye.classList.add("ti-eye");
            } else {
                passwordField.type = "password";
                eye.classList.remove("ti-eye");
                eye.classList.add("ti-eye-off");
            }
        }

        window.onload = function () {
            document.getElementById('tab-1').click();
        };

        function Redirigir() {
            var label = document.querySelector('label.tab-checked');
            var loading = document.querySelector('div.tab-loading');

            // Si se encuentra el label, quitar la clase
            if (label) {
                label.classList.remove('tab-checked');
            }

            var url = '@Url.Action("Registro", "Acceso")';

            // Redirigir a la URL generada
            setTimeout(function () {
                window.location.href = url;
                loading.classList.remove('d-none');
            }, 250); // Retraso de 2 segundos (2000 milisegundos)
        }
    </script>
}