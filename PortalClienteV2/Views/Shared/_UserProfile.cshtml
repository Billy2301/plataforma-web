@using BL.IServices
@using DA.CentralContext
@using Entity.CentralModels
@using Microsoft.AspNetCore.Identity;
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager
@inject IUsuarioService usuarioService



@if (SignInManager.IsSignedIn(User))
{
    var appUsuario = await UserManager.FindByNameAsync(User.Identity.Name);
    UvAspnetUserRole? userRole = await usuarioService.ObtenerUserRoles(appUsuario.Id);
    if(userRole != null)
    {
        if (string.IsNullOrEmpty(userRole.ApellidoPaterno) ||
        string.IsNullOrEmpty(userRole.ApellidoMaterno) ||
        string.IsNullOrEmpty(userRole.Nombres) ||
        string.IsNullOrEmpty(userRole.Telefono) ||
        !userRole.FechaNacimiento.HasValue ||
        string.IsNullOrEmpty(userRole.Dni) ||
        !userRole.Sexo.HasValue)
        {
            <li class="nav-item dropdown">
                <a class="nav-link nav-icon-hover"
                   href="javascript:void(0)"
                   id="drop2"
                   data-bs-toggle="dropdown"
                   aria-expanded="false">
                    <i class="ti ti-bell-ringing"></i>
                    @* <span class="popup-badge rounded-pill bg-warning text-white fs-2"></span> *@
                </a>
                <div class="dropdown-menu content-dd dropdown-menu-end dropdown-menu-animate-up"
                     aria-labelledby="drop2">
                    <div class="d-flex align-items-center justify-content-between py-3 px-7">
                        <h5 class="mb-0 fs-5 fw-semibold">Notificaciones</h5>
                        <span class="badge text-bg-primary rounded-4 px-3 py-1 lh-sm">1 nuevos</span>
                    </div>
                    <div class="message-body" data-simplebar>
                        <a asp-controller="Usuario" asp-area="" asp-action="EditarPerfil"
                           asp-route-idRef="@UserManager.GetUserId(User)"
                           class="py-6 px-7 d-flex align-items-center dropdown-item">
                            <span class="me-3">
                                <i class="ti ti-message-dots fs-6 text-primary me-2 d-flex"></i>
                            </span>
                            <div class="w-75 d-inline-block v-middle">
                                <h6 class="mb-1 fw-semibold lh-base">Complete su perfil</h6>
                                <span class="fs-2 d-block text-body-secondary text-wrap">
                                    Para ofrecerle una experiencia personalizada y asegurarnos de que pueda
                                    aprovechar al máximo todos nuestros servicios, lo invitamos a completar los
                                    datos de su perfil.
                                </span>
                            </div>
                        </a>
                    </div>
                    <div class="py-6 px-7 mb-1">
                        <button class="btn btn-outline-primary w-100 d-none">Ver todas las notificaciones</button>
                    </div>

                </div>
            </li>
        }        
    }

<li id="ShowEvalButon" class="d-none">
    <a id="evalCount" class="nav-link nav-icon-hover position-relative" href="javascript:void(0)" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">
        <i class="ti ti-shopping-cart fs-5"></i> 
    </a>
</li>
<li class="nav-item dropdown">
    <a class="nav-link pe-0"
       href="javascript:void(0)"
       id="drop1"
       data-bs-toggle="dropdown"
       aria-expanded="false">
        <div class="d-flex align-items-center">
            <div class="user-profile-img">
                @if (!string.IsNullOrEmpty(userRole.UrlImagen))
                {
                        if (userRole.UrlImagen != "user.png")
                        {
                            <img src="@Url.Action("VerImagen", "Usuario", new { img = userRole.UrlImagen, h = 35, w = 35 })" alt="Usuario" class="rounded-circle" />
                        }
                        else if (!string.IsNullOrEmpty(userRole.Nombres) && !string.IsNullOrEmpty(userRole.ApellidoPaterno))
                        {
                            <img src="@Url.Action("VerAvatar", "Usuario", new { initials = string.Concat(userRole.Nombres.First(),userRole.ApellidoPaterno.First()) })" alt="Avatar" width="35" height="35" class="rounded-circle" />
                        }
                        else
                        {                            
                            <img src="@Url.Action("VerImagen", "Usuario", new { img = userRole.UrlImagen, h = 35, w = 35 })" alt="Usuario" class="rounded-circle" />
                        }
                }
                else
                {
                        if (!string.IsNullOrEmpty(userRole.Nombres) && !string.IsNullOrEmpty(userRole.ApellidoPaterno))
                        {
                            <img src="@Url.Action("VerAvatar", "Usuario", new { initials = string.Concat(userRole.Nombres.First(),userRole.ApellidoPaterno.First()) })" alt="Avatar" width="35" height="35" class="rounded-circle" />
                        }
                        else
                        {
                            <img src="~/assets/images/user/user.png" alt="Usuario" height="35" width="35" class="rounded-circle" />    
                        }
                }
            </div>
        </div>
    </a>
    <div class="dropdown-menu content-dd dropdown-menu-end dropdown-menu-animate-up"
         aria-labelledby="drop1">
        <div class="profile-dropdown position-relative" data-simplebar>
            <div class="py-3 px-7 pb-0">
                    <h5 class="mb-0 fs-5 fw-semibold">Perfil del usuario</h5>
            </div>
            <div class="d-flex align-items-center py-9 mx-7 border-bottom">
                    @if (!string.IsNullOrEmpty(userRole.UrlImagen))
                    {
                        if (userRole.UrlImagen != "user.png")
                        {
                            <img src="@Url.Action("VerImagen", "Usuario", new { img = userRole.UrlImagen, h = 80, w = 80 })" alt="Usuario" class="rounded-circle" />
                        }
                        else if (!string.IsNullOrEmpty(userRole.Nombres) && !string.IsNullOrEmpty(userRole.ApellidoPaterno))
                        {
                            <img src="@Url.Action("VerAvatar", "Usuario", new { initials = string.Concat(userRole.Nombres.First(),userRole.ApellidoPaterno.First()) })" alt="Avatar" width="35" height="35" class="rounded-circle" />
                        }
                        else
                        {
                            <img src="@Url.Action("VerImagen", "Usuario", new { img = userRole.UrlImagen, h = 80, w = 80 })" alt="Usuario" class="rounded-circle" />
                        }
                    }
                    else
                    {
                        if (!string.IsNullOrEmpty(userRole.Nombres) && !string.IsNullOrEmpty(userRole.ApellidoPaterno))
                        {
                            <img src="@Url.Action("VerAvatar", "Usuario", new { initials = string.Concat(userRole.Nombres.First(),userRole.ApellidoPaterno.First()) })" alt="Avatar" width="80" height="80" class="rounded-circle" />
                        }
                        else
                        {
                            <img src="~/assets/images/user/user.png" alt="Usuario" height="80" width="80" class="rounded-circle" />
                        }
                    }
                <div class="ms-3">
                        <h5 class="mb-1 fs-3"><strong>@userRole.Nombres @userRole.ApellidoPaterno</strong></h5>
                        <span class="mb-1 d-block"><small>@userRole.Rol</small></span>
                    <p class="mb-0 d-flex align-items-center gap-2">
                            <i class="ti ti-mail fs-4"></i> <small>@UserManager.GetUserName(User)</small>
                    </p>
                </div>
            </div>
            <div class="message-body">
                    <a asp-controller="Usuario" asp-area="" asp-action="EditarPerfil"
                       asp-route-idRef="@UserManager.GetUserId(User)"
                   class="py-8 px-7 mt-8 d-flex align-items-center">
                    <span class="d-flex align-items-center justify-content-center text-bg-light rounded-1 p-6">
                            <img src="~/assets/images/svgs/icon-account.svg"
                             alt=""
                             width="24"
                             height="24" />
                    </span>
                    <div class="w-75 d-inline-block v-middle ps-3">
                            <h6 class="mb-1 fs-3 fw-semibold lh-base">Mi perfil</h6>
                            <span class="fs-2 d-block text-body-secondary">
                                
                                Configuraciones de la cuenta
                            </span>
                    </div>
                </a>
                <a class="py-8 px-7 d-flex align-items-center"
                     asp-controller="Usuario" asp-action="CambiarPassword" >
                    <span class="d-flex align-items-center justify-content-center text-bg-light rounded-1 p-6">
                            <img src="~/assets/images/svgs/lock-open.svg"
                             alt=""
                             width="24"
                             height="24" />
                    </span>
                    <div class="w-75 d-inline-block v-middle ps-3">
                        <h6 class="mb-1 fs-3 fw-semibold lh-base">Contraseña</h6>
                        <span class="fs-2 d-block text-body-secondary">Cambiar contraseña</span>
                    </div>
                </a>
                    @if (User.IsInRole("Administrador"))
                    {
                        <a class="py-8 px-7 d-flex align-items-center"
                           asp-controller="Usuario" asp-action="Index">
                            <span class="d-flex align-items-center justify-content-center text-bg-light rounded-1 p-6">
                                <img src="~/assets/images/svgs/passkey.svg"
                                     alt=""
                                     width="24"
                                     height="24" />
                            </span>
                            <div class="w-75 d-inline-block v-middle ps-3">
                                <h6 class="mb-1 fs-3 fw-semibold lh-base">Usuarios</h6>
                                <span class="fs-2 d-block text-body-secondary">Administrar Usuarios</span>
                            </div>
                        </a>
                    }

                <a href="../minisidebar/app-notes.html" class="py-8 px-7 d-flex align-items-center d-none" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">
                    <span class="d-flex align-items-center justify-content-center text-bg-light rounded-1 p-6">
                            <img src="~/assets/images/svgs/settings.svg"
                             alt=""
                             width="24"
                             height="24" />
                    </span>
                    <div class="w-75 d-inline-block v-middle ps-3">
                        <h6 class="mb-1 fs-3 fw-semibold lh-base">Configuraciones</h6>
                        <span class="fs-2 d-block text-body-secondary">Personalizar Pagina</span>
                    </div>
                </a>
            </div>
            <div class="d-grid py-4 px-7 pt-8">
                <div class="upgrade-plan bg-warning-subtle position-relative overflow-hidden rounded-4 p-4 mb-9">
                    <div class="row d-none">
                        <div class="col-6">
                            <h5 class="fs-4 mb-3 fw-semibold">Resporte</h5>
                            <button class="btn btn-warning">Historial</button>
                        </div>
                        <div class="col-6">
                            <div class="m-n4 unlimited-img">
                                    <img src="~/assets/images/backgrounds/unlimited-bg.png"
                                     alt=""
                                     class="w-100" />
                            </div>
                        </div>
                    </div>
                </div>
                    <form id="logoutForm" method="post" asp-controller="Acceso" asp-action="CerrarSession">
                        <button type="submit" class="btn btn-outline-primary w-100">Cerrar sesión</button>
                    </form>
            </div>
        </div>

    </div>
</li>
}

